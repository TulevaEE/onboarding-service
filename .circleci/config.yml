version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@9.5.1
  aws-cli: circleci/aws-cli@5.3.2
  codecov: codecov/codecov@5.3.0
  snyk: snyk/snyk@2.3.0

executors:
  machine-with-docker-layer-caching:
    machine:
      image: ubuntu-2404:current
      docker_layer_caching: true
    resource_class: medium

jobs:
  build:
    environment:
      TERM: dumb
      SPRING_PROFILES_ACTIVE: ci,test
      GRADLE_OPTS: -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4
    docker:
      - image: cimg/openjdk:21.0
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - restore_cache:
          keys:
            - v2-gradle-{{ arch }}-{{ checksum "build.gradle.kts" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - v2-gradle-{{ arch }}-{{ checksum "build.gradle.kts" }}
            - v2-gradle-{{ arch }}-
      - run:
          name: Build
          command: ./gradlew build --no-daemon --stacktrace --build-cache

      - run:
          name: Copy heap dump if it exists
          when: always
          command: |
            if [ -f /tmp/heapdump.hprof ]; then
              cp /tmp/heapdump.hprof ./heapdump.hprof
              echo "Heap dump copied for upload"
            else
              echo "No heap dump found"
            fi

      - store_artifacts:
          path: ./heapdump.hprof
          destination: heapdump

      - snyk/scan:
          fail-on-issues: false
          organization: tuleva

      - store_test_results:
          path: ./build/test-results

      - store_artifacts:
          path: ./build/reports
          destination: /reports

      - codecov/upload

      - save_cache:
          key: v2-gradle-{{ arch }}-{{ checksum "build.gradle.kts" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - .gradle

      - persist_to_workspace:
          root: .
          paths:
            - build

  flag-for-additional-review:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Check for changes in monitored files on master branch
          command: |
            PATHS_TO_WATCH=(
                "src/main/resources/templates"
                "src/main/java/ee/tuleva/onboarding/payment/recurring"
            )

            echo "Monitoring paths on branch $CIRCLE_BRANCH:"
            for path_item in "${PATHS_TO_WATCH[@]}"; do
                echo "- ${path_item}"
            done
            
            CHANGED_FILES_OUTPUT=""

            if git rev-parse --verify HEAD~1 > /dev/null 2>&1; then
                echo "Comparing HEAD with HEAD~1 for monitored paths."
                CHANGED_FILES_OUTPUT=$(git diff --name-only HEAD~1 HEAD -- "${PATHS_TO_WATCH[@]}")
            else
                echo "No parent commit found (HEAD~1 does not exist). Skipping diff."
            fi

            if [ -n "$CHANGED_FILES_OUTPUT" ]; then
                echo "NOTICE: Files requiring additional review changed in monitored paths on master branch!"
                echo "${CHANGED_FILES_OUTPUT}"
            
                COMMIT_INFO_URL="$CIRCLE_BUILD_URL"
                COMMIT_SHA_SHORT=$(echo "$CIRCLE_SHA1" | cut -c1-7)
                GITHUB_COMMIT_URL="https://github.com/TulevaEE/onboarding-service/commit/$CIRCLE_SHA1"
                MESSAGE_CONTEXT="Branch: $CIRCLE_BRANCH (master), Commit: $COMMIT_SHA_SHORT, Triggered by: $CIRCLE_USERNAME."

                NOTIFICATION_MESSAGE="Additional review requested for changes in monitored paths on the master branch.\nDetails: $MESSAGE_CONTEXT\nFiles:\n${CHANGED_FILES_OUTPUT}\n CircleCI Build: $COMMIT_INFO_URL \nPlease review GitHub Commit: $GITHUB_COMMIT_URL"
            
                echo -e "$NOTIFICATION_MESSAGE"

                JSON_ESCAPED_MESSAGE=$(echo "$NOTIFICATION_MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
                TARGET_CHANNEL="review-changes" 

                if [ -n "$SLACK_REVIEW_CHANGES_WEBHOOK_URL" ]; then # Using your new variable name
                  PAYLOAD="{\"text\":\"${JSON_ESCAPED_MESSAGE}\", \"channel\":\"${TARGET_CHANNEL}\"}"
                  curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_REVIEW_CHANGES_WEBHOOK_URL"
                  echo "Slack notification attempt sent to channel: ${TARGET_CHANNEL}."
                else
                  echo "SLACK_REVIEW_CHANGES_WEBHOOK_URL not set in CircleCI environment variables for this job/context. Skipping actual Slack notification."
                fi
            else
                echo "No files requiring additional review changed in monitored paths on master branch (or no applicable changes found)."
            fi

  deploy-ecs:
    docker:
      - image: cimg/aws:2025.01
    steps:
      - run:
          name: Retag latest as ecs-latest and force ECS deployment
          command: |
            echo "ðŸ·ï¸  Retagging :latest as :ecs-latest for ECS..."

            # Get manifest from :latest
            MANIFEST=$(aws ecr batch-get-image \
              --repository-name onboarding-service \
              --image-ids imageTag=latest \
              --region eu-central-1 \
              --query 'images[0].imageManifest' \
              --output text)

            # Retag as :ecs-latest
            aws ecr put-image \
              --repository-name onboarding-service \
              --image-tag ecs-latest \
              --image-manifest "$MANIFEST" \
              --region eu-central-1

            echo "âœ… Image retagged as :ecs-latest"
            echo "ðŸš€ Forcing ECS production service update..."

            # Force production ECS update
            aws ecs update-service \
              --cluster onboarding-service-cluster \
              --service onboarding-service-production \
              --force-new-deployment \
              --region eu-central-1

            echo "âœ… ECS production deployment initiated"

  notify-sentry-deploy:
    docker:
      - image: cimg/base:stable
    resource_class: small
    environment:
      SENTRY_PROJECT: onboarding-service
    steps:
      - checkout
      - run:
          name: Get Sentry CLI version
          command: |
            SENTRY_CLI_VERSION=$(curl -s https://api.github.com/repos/getsentry/sentry-cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            echo "export SENTRY_CLI_VERSION=${SENTRY_CLI_VERSION}" >> $BASH_ENV
            echo "Latest Sentry CLI version: ${SENTRY_CLI_VERSION}"
      - restore_cache:
          keys:
            - v1-sentry-cli-{{ arch }}-{{ .Environment.SENTRY_CLI_VERSION }}
            - v1-sentry-cli-{{ arch }}-
      - run:
          name: Install or update Sentry CLI
          command: |
            if [ -f ~/.local/bin/sentry-cli ]; then
              INSTALLED_VERSION=$(~/.local/bin/sentry-cli --version | awk '{print $2}')
              echo "Installed version: ${INSTALLED_VERSION}"
              echo "Latest version: ${SENTRY_CLI_VERSION}"
              if [ "${INSTALLED_VERSION}" = "${SENTRY_CLI_VERSION}" ]; then
                echo "Sentry CLI is up to date (cached)"
                exit 0
              fi
            fi
            echo "Installing Sentry CLI ${SENTRY_CLI_VERSION}"
            curl -sL https://sentry.io/get-cli/ | bash
      - save_cache:
          key: v1-sentry-cli-{{ arch }}-{{ .Environment.SENTRY_CLI_VERSION }}
          paths:
            - ~/.local/bin/sentry-cli
      - run:
          name: Create release and notify Sentry of deploy
          command: |
            export SENTRY_RELEASE=$(sentry-cli releases propose-version)
            sentry-cli releases new -p $SENTRY_PROJECT $SENTRY_RELEASE
            sentry-cli releases set-commits $SENTRY_RELEASE --auto
            sentry-cli releases finalize $SENTRY_RELEASE
            sentry-cli releases deploys $SENTRY_RELEASE new -e $SENTRY_ENVIRONMENT

workflows:
  version: 2
  onboarding-service-workflow:
    jobs:
      - build:
          context:
            - snyk
            - codecov

      - flag-for-additional-review:
          requires:
            - build
          context:
            - slack
          filters:
            branches:
              only: master

      - aws-ecr/build_and_push_image:
          name: build_and_push_image
          executor: machine-with-docker-layer-caching
          requires:
            - build
            - flag-for-additional-review
          context: aws
          auth:
            - aws-cli/setup
          path: build/docker
          build_path: build/docker
          repo: onboarding-service
          tag: 'latest,${CIRCLE_SHA1}'
          attach_workspace: true
          workspace_root: .
          filters:
            branches:
              only: master

      - deploy-ecs:
          requires: [ build_and_push_image ]
          context: aws
          filters:
            branches:
              only: master

      - notify-sentry-deploy:
          requires: [ deploy-ecs ]
          context: sentry
          filters:
            branches:
              only: master
