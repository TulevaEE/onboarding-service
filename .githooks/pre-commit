#!/bin/bash

echo "üîç Running tests and verifying coverage..."

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    echo -n " "
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

#echo "üì¶ Stashing uncommitted changes..."
#git stash -q --keep-index || true

echo "‚ú® Applying Spotless formatting..."
./gradlew spotlessApply --no-daemon --quiet
if [ $? -ne 0 ]; then
    echo "‚ùå Failed to apply Spotless formatting. Please check your Spotless configuration."
    exit 1
fi

# Check if Spotless made any changes
if ! git diff --quiet; then
    echo "üìù Spotless made formatting changes. Adding modified files to the commit..."
    # Get list of modified files and add them to the staging area
    git diff --name-only | while read -r file; do
        if [ -f "$file" ]; then
            git add "$file"
            echo "   Added: $file"
        fi
    done
    echo "‚úÖ Spotless formatting applied and changes staged."
else
    echo "‚úÖ Spotless formatting check passed (no changes needed)."
fi

exit 0
